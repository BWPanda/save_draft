<?php

/**
 * @file
 * Main file for the Save Draft module, which adds a 'Save as draft' button to content types.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function save_draft_form_node_form_alter(&$form, &$form_state) {
  // Only alter the form if the status checkbox is present.
  if (isset($form['options']['status']) && (!isset($form['options']['status']['#access']) || $form['options']['status']['#access'])) {
    $form['options']['#title'] = t('Promotion settings');
    $form['options']['#attributes']['class'] = array('node-promotion-options');
    $form['options']['#attached'] = array(
      'js' => array(
        'vertical-tabs' => drupal_get_path('module', 'save_draft') . '/save_draft.js',
      ),
    );
    $form['options']['status'] = false;
    if (isset($form['nid']['#value'])) {
      if ($form['#node']->status == 1) {
        $form['actions']['draft'] = array(
          '#type' => 'submit',
          '#class' => 'form-submit',
          '#value' => t('Unpublish'),
          '#weight' => '9',
          '#validate' => array('save_draft_validate'),
          '#submit' => array('save_draft_submit')
        );
        $form['actions']['submit']['#value'] = t('Save');
        $form['actions']['submit']['#validate'][] = 'save_draft_publish_validate';
      }
      else {
        $form['actions']['draft'] = array(
          '#type' => 'submit',
          '#class' => 'form-submit',
          '#value' => t('Save'),
          '#weight' => '0',
          '#validate' => array('save_draft_validate'),
          '#submit' => array('save_draft_submit')
        );
        $form['actions']['submit']['#value'] = t('Publish');
        $form['actions']['submit']['#validate'][] = 'save_draft_publish_validate';
      }
    }
    else {
      $form['actions']['draft'] = array(
        '#type' => 'submit',
        '#class' => 'form-submit',
        '#value' => t('Save as draft'),
        '#weight' => '9',
        '#validate' => array('save_draft_validate'),
        '#submit' => array('save_draft_submit')
      );
      $form['actions']['submit']['#value'] = t('Publish');
      $form['actions']['submit']['#validate'][] = 'save_draft_publish_validate';
    }
  }
}

/**
 * Handles save draft form validation
 */
function save_draft_validate($form, &$form_state) {
  $form_state['values']['status'] = 0;
}

/**
 * Handles save draft form submission
 */
function save_draft_submit($form, &$form_state) {
  node_form_submit($form, $form_state);
}

/**
 * Handles publish form validation
 */
function save_draft_publish_validate($form, &$form_state) {
  $form_state['values']['status'] = 1;
}